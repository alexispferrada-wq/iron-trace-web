<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reportes Avanzados</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 20px; }
        .header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .grid-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #34495e; color: white; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üìä Inteligencia de Negocios</h1>
        <div>
            <a href="/reportes/descargar_pdf" style="background:#e74c3c; color:white; padding:10px 20px; text-decoration:none; border-radius:4px;">üìÑ Descargar PDF</a>
            <a href="/dashboard" style="color:#555; text-decoration:none; margin-left:15px;">Volver</a>
        </div>
    </div>

    <div class="grid-charts">
        <div class="chart-card">
            <h3>Consumo Diario Insumos ($)</h3>
            <canvas id="chartInsumos"></canvas>
        </div>
        <div class="chart-card">
            <h3>Estado Herramientas (Bodega vs Terreno)</h3>
            <div style="max-width:300px; margin:0 auto;">
                <canvas id="chartComparativa"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-card">
        <h3>Historial de Movimientos</h3>
        <form method="POST" style="margin-bottom:15px; display:flex; gap:10px;">
            <input type="text" name="search_term" placeholder="Filtrar por RUT, ID Herramienta..." value="{{ search_term }}" style="padding:8px; border:1px solid #ddd; width:100%;">
            <button type="submit" style="padding:8px 20px; background:#2980b9; color:white; border:none; cursor:pointer;">FILTRAR</button>
        </form>
        
        <table>
            <thead><tr><th>Fecha</th><th>Trabajador</th><th>√çtem</th><th>Tipo</th><th>Estado</th></tr></thead>
            <tbody>
                {% for m in movimientos %}
                <tr>
                    <td>{{ m.fecha_salida }}</td>
                    <td>{{ m.worker_id }}</td>
                    <td>{{ m.nombre }} <small>({{ m.tool_id }})</small></td>
                    <td>{{ m.tipo_item }}</td>
                    <td style="font-weight:bold; color:{{ 'green' if m.estado=='DEVUELTO' else 'orange' }}">{{ m.estado }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Datos desde Flask
        const dataInsumos = {{ chart_days | tojson }};
        const dataComp = {{ chart_comparativa | tojson }};

        // 1. Gr√°fico Lineal (Dinero)
        new Chart(document.getElementById('chartInsumos'), {
            type: 'line',
            data: {
                labels: dataInsumos.labels,
                datasets: [{
                    label: 'Gasto Diario ($)',
                    data: dataInsumos.values,
                    borderColor: '#e67e22',
                    fill: false
                }]
            }
        });

        // 2. Gr√°fico Torta (Stock)
        new Chart(document.getElementById('chartComparativa'), {
            type: 'doughnut',
            data: {
                labels: dataComp.labels,
                datasets: [{
                    data: dataComp.values,
                    backgroundColor: ['#2ecc71', '#3498db'] // Verde (Bodega), Azul (Terreno)
                }]
            }
        });
    </script>

</body>
</html>
