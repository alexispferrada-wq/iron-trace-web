<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Terminal Operador - Iron Trace</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #111; color: #eee; margin: 0; display: flex; height: 100vh; }
        
        /* LAYOUT 50/50 */
        .col-salida { width: 50%; padding: 20px; border-right: 2px solid #333; display: flex; flex-direction: column; background: #1a1a1a; }
        .col-devolucion { width: 50%; padding: 20px; background: #000; display: flex; flex-direction: column; }

        h2 { margin-top: 0; border-bottom: 2px solid #444; padding-bottom: 10px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; }
        
        /* INPUTS */
        input { padding: 12px; font-size: 1.1em; background: #222; color: white; border: 1px solid #555; text-align: center; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        input:focus { outline: 2px solid #3498db; background: #333; }
        
        /* TABLAS Y LISTAS */
        .table-scroll { flex: 1; overflow-y: auto; border: 1px solid #333; margin: 10px 0; background: #111; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; background: #222; padding: 10px; position: sticky; top: 0; color: #888; }
        td { padding: 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        
        /* SUGERENCIAS DE BUSQUEDA */
        .suggestions { background: #2c3e50; position: absolute; width: 60%; max-height: 250px; overflow-y: auto; display: none; border: 1px solid #34495e; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .sugg-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #34495e; }
        .sugg-item:hover { background: #3498db; color: white; }
        
        /* BOTONES */
        button { cursor: pointer; border: none; padding: 10px; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .btn-add { background: #3498db; color: white; width: 15%; font-size: 1.2em; }
        .btn-finish { background: #27ae60; color: white; padding: 15px; font-size: 1.2em; width: 100%; margin-top: auto; }
        .btn-confirm-ret { background: #e67e22; color: white; padding: 15px; font-size: 1.2em; width: 100%; margin-top: auto; display: none; }
        
        /* CHECKBOX CUSTOM */
        .check-big { transform: scale(1.5); cursor: pointer; accent-color: #e67e22; }
        .qty-input { width: 60px; padding: 5px; font-size: 1em; text-align: center; margin: 0; display: inline-block; background: #333; border: 1px solid #555; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; }
        .badge-tool { background: #3498db; color: white; }
        .badge-insumo { background: #f1c40f; color: black; }
    </style>
</head>
<body>

    <div class="col-salida">
        <h2 style="color:#3498db;">üì§ Nuevo Pr√©stamo</h2>
        
        <input type="text" id="worker_out" placeholder="1. Escanear RUT Trabajador" autofocus>
        
        <div style="display: flex; gap: 10px; position: relative;">
            <input type="text" id="tool_search" placeholder="2. Buscar Herramienta..." onkeyup="buscar(this.value)" autocomplete="off" style="flex: 3;">
            <input type="number" id="tool_qty" value="1" min="1" style="flex: 1;">
            <button class="btn-add" onclick="agregar()">+</button>
            <div id="sugg" class="suggestions"></div>
        </div>

        <div class="table-scroll">
            <table id="cart_table">
                <thead><tr><th>√çtem</th><th>Cant.</th><th>X</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <button class="btn-finish" onclick="finalizarSalida()">CONFIRMAR SALIDA & IMPRIMIR</button>
    </div>

    <div class="col-devolucion">
        <h2 style="color:#e67e22;">üì• Recepci√≥n / Devoluci√≥n</h2>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="scan_ret" placeholder="Escanear RUT o Ticket..." onchange="buscarPendientes()">
            <button onclick="buscarPendientes()" style="background:#e67e22; color:white; width:25%;">BUSCAR</button>
        </div>

        <div class="table-scroll" id="return_area">
            <p style="text-align:center; color:#666; margin-top:50px;">
                Ingrese el RUT del trabajador para ver qu√© debe.
            </p>
        </div>

        <button id="btn_process_ret" class="btn-confirm-ret" onclick="procesarDevolucionMasiva()">
            CONFIRMAR RECEPCI√ìN SELECCIONADA
        </button>
        
        <div style="text-align:center; margin-top:10px;">
            <a href="/logout" style="color:#ff4444; text-decoration:none;">[CERRAR SESI√ìN]</a>
        </div>
    </div>

    <script>
        // --- LOGICA SALIDA ---
        let carrito = [];
        let currentItem = null;

        function buscar(q) {
            if(q.length < 1){ document.getElementById('sugg').style.display='none'; return; }
            fetch('/api/buscar_herramientas?q='+q).then(r=>r.json()).then(data=>{
                let box = document.getElementById('sugg'); box.innerHTML='';
                if(data.length>0){
                    box.style.display='block';
                    data.forEach(i=>{
                        let d = document.createElement('div'); d.className='sugg-item';
                        let color = i.stock > 0 ? '#2ecc71':'#e74c3c';
                        d.innerHTML = `<b>${i.nombre}</b> <span style='float:right; color:${color}'>Stock: ${i.stock}</span>`;
                        d.onclick=()=>{ 
                            currentItem=i; document.getElementById('tool_search').value=i.nombre;
                            box.style.display='none'; 
                            if(i.tipo==='INSUMO') document.getElementById('tool_qty').select();
                            else document.getElementById('tool_qty').focus();
                        }; box.appendChild(d);
                    });
                } else box.style.display='none';
            });
        }

        function agregar() {
            if(!currentItem) return alert("Seleccione √≠tem");
            let qty = parseInt(document.getElementById('tool_qty').value);
            if(qty > currentItem.stock) return alert("Stock insuficiente");
            carrito.push({...currentItem, cantidad: qty});
            renderCart();
            currentItem=null; document.getElementById('tool_search').value=''; document.getElementById('tool_qty').value='1';
            document.getElementById('tool_search').focus();
        }

        function renderCart() {
            let tbody = document.querySelector('#cart_table tbody'); tbody.innerHTML='';
            carrito.forEach((it,i)=>{
                tbody.innerHTML += `<tr><td>${it.nombre}</td><td style='text-align:center'>${it.cantidad}</td><td style='color:#e74c3c; cursor:pointer' onclick='carrito.splice(${i},1);renderCart()'>‚úñ</td></tr>`;
            });
        }

        function finalizarSalida() {
            let w = document.getElementById('worker_out').value.trim();
            if(!w || carrito.length===0) return alert("Faltan datos");
            fetch('/procesar_salida_masiva', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({worker_id: w, items: carrito})
            }).then(r=>r.json()).then(d=>{
                if(d.status==='ok'){
                    window.open('/ticket/'+d.ticket_id, '_blank', 'width=400,height=600');
                    carrito=[]; renderCart(); document.getElementById('worker_out').value='';
                } else alert(d.msg);
            });
        }

       // --- L√ìGICA DEVOLUCI√ìN ROBUSTA ---
        function buscarPendientes() {
            let input = document.getElementById('scan_ret').value.trim().toUpperCase();
            if(!input) return;

            let div = document.getElementById('return_area');
            div.innerHTML = '<p style="text-align:center; color:yellow; font-size:1.2em;">üîç Buscando en Base de Datos...</p>';
            
            // Ocultar bot√≥n de confirmar mientras busca
            document.getElementById('btn_process_ret').style.display = 'none';

            // 1. Limpieza de input (Si escane√≥ un QR de ticket "TICKET:ABC")
            let limpio = input.replace('TICKET:', '').trim();
            
            // 2. Decidir si buscar por RUT o TICKET
            // Si tiene gui√≥n "-" asumimos RUT, si no, Ticket
            let url = '';
            let tipoBusqueda = '';
            
            if (limpio.includes('-') || limpio.length > 8) {
                url = '/api/prestamos_trabajador?worker_id=' + limpio;
                tipoBusqueda = 'RUT';
            } else {
                url = '/api/prestamos_ticket?ticket_id=' + limpio;
                tipoBusqueda = 'TICKET';
            }
            
            fetch(url)
            .then(r => r.json())
            .then(respuesta => {
                if (respuesta.status === 'ok') {
                    // ¬°√âXITO! Mostrar tabla
                    renderPendientes(respuesta.data);
                } else if (respuesta.status === 'empty') {
                    // Trabajador existe pero no debe nada
                    div.innerHTML = `
                        <div style="background:#2ecc71; color:black; padding:20px; border-radius:5px; text-align:center;">
                            <h3>‚úî PAZ Y SALVO</h3>
                            <p>${respuesta.msg}</p>
                        </div>`;
                } else {
                    // ERROR (No existe RUT o Ticket)
                    div.innerHTML = `
                        <div style="background:#e74c3c; color:white; padding:20px; border-radius:5px; text-align:center;">
                            <h3>‚ùå NO ENCONTRADO</h3>
                            <p>${respuesta.msg}</p>
                            <small>Intente escanear nuevamente o ingresar el c√≥digo manual.</small>
                        </div>`;
                }
            })
            .catch(err => {
                div.innerHTML = `<p style="color:red; text-align:center;">Error de conexi√≥n: ${err}</p>`;
            });

            document.getElementById('scan_ret').value = '';
            document.getElementById('scan_ret').focus();
        }

        function renderPendientes(data) {
            let div = document.getElementById('return_area');
            
            // Generar tabla con Checkboxes y Cantidades Editables
            let html = `
                <div style="background:#333; padding:10px; margin-bottom:10px; border-left:5px solid #e67e22;">
                    Resultados encontrados: <b>${data.length}</b> √≠tems pendientes.
                </div>
                <table>
                    <thead><tr><th style="width:50px;">Devolver</th><th>√çtem</th><th>Cant.</th></tr></thead>
                    <tbody>`;
            
            data.forEach(p => {
                html += `
                <tr style="background:${p.tipo==='INSUMO'?'#222':'#1a1a1a'}">
                    <td style="text-align:center;">
                        <input type="checkbox" class="check-big ret-check" data-id="${p.prestamo_id}" onchange="toggleRow(this)">
                    </td>
                    <td>
                        <div style="font-weight:bold; color:#fff;">${p.nombre}</div>
                        <small style="color:#888;">ID: ${p.tool_id}</small>
                    </td>
                    <td style="text-align:center;">
                        <input type="number" class="qty-input" id="qty_${p.prestamo_id}" value="${p.cantidad}" max="${p.cantidad}" min="1" disabled>
                        <br><small style="color:#555">de ${p.cantidad}</small>
                    </td>
                </tr>`;
            });
            html += "</tbody></table>";
            div.innerHTML = html;
            document.getElementById('btn_process_ret').style.display = 'block';
        }
        function toggleRow(chk) {
            let input = document.getElementById('qty_' + chk.getAttribute('data-id'));
            input.disabled = !chk.checked;
            if(chk.checked) input.focus();
        }

        function procesarDevolucionMasiva() {
            let checks = document.querySelectorAll('.ret-check:checked');
            if(checks.length === 0) return alert("Seleccione al menos un √≠tem para recibir.");
            
            let items = [];
            checks.forEach(c => {
                let pid = c.getAttribute('data-id');
                let q = document.getElementById('qty_'+pid).value;
                items.push({ id: pid, cantidad: q });
            });

            fetch('/procesar_devolucion_compleja', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ items: items })
            }).then(r=>r.json()).then(d=>{
                if(d.status==='ok'){
                    // ABRIR TICKET DEVOLUCI√ìN
                    window.open('/ticket_devolucion?ids='+d.ids, '_blank', 'width=400,height=600');
                    // Limpiar pantalla
                    document.getElementById('return_area').innerHTML = '<p style="text-align:center; color:#2ecc71;">Recepci√≥n Exitosa.</p>';
                    document.getElementById('btn_process_ret').style.display = 'none';
                } else {
                    alert("Error: " + d.msg);
                }
            });
        }
    </script>
</body>
</html>
