<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operador | Iron Trace</title>
    <style>
        /* BASE MODERN FLAT */
        :root { --dark: #111827; --gray: #1f2937; --blue: #3b82f6; --orange: #f59e0b; --green: #10b981; --red: #ef4444; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--dark); color: #f3f4f6; margin: 0; display: flex; height: 100vh; flex-direction: row; }
        
        /* LAYOUT RESPONSIVO */
        .panel { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel-left { background: #1a1a1a; border-right: 1px solid #333; }
        .panel-right { background: #0f0f0f; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .panel { height: 100vh; border-right: none; border-bottom: 2px solid #333; }
        }

        /* COMPONENTES */
        h2 { margin: 0 0 15px 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
        
        input { background: #2d2d2d; border: 1px solid #444; color: white; padding: 15px; font-size: 1.1rem; border-radius: 8px; width: 100%; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--blue); outline: none; background: #333; }

        .btn-main { width: 100%; padding: 18px; border: none; border-radius: 8px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: auto; text-transform: uppercase; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-orange { background: var(--orange); color: #111; }
        
        /* LISTAS */
        .list-container { flex: 1; overflow-y: auto; margin: 15px 0; border: 1px solid #333; border-radius: 8px; background: #161616; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #222; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 5px; }
        .bg-tool { background: #1e3a8a; color: #bfdbfe; }
        .bg-insu { background: #451a03; color: #fed7aa; }

        /* AUTOCOMPLETADO FLOTANTE */
        .input-group { position: relative; margin-bottom: 15px; }
        .suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: #2d2d2d; border: 1px solid #444; border-radius: 0 0 8px 8px; z-index: 100; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
        .sugg-row { padding: 12px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; }
        .sugg-row:hover { background: var(--blue); }
        .sugg-detail { font-size: 0.85em; color: #aaa; }
        .sugg-row:hover .sugg-detail { color: #eee; }

        .search-wrapper { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-add { width: 60px; font-size: 1.5rem; background: #333; color: var(--blue); border: 1px solid #444; border-radius: 8px; cursor: pointer; }
        
        /* CHECKBOX GRANDE */
        .check-big { transform: scale(1.5); accent-color: var(--orange); cursor: pointer; }
    </style>
</head>
<body>

    <div class="panel panel-left">
        <h2 style="color: var(--blue);">üì§ Pr√©stamo / Salida</h2>
        
        <div class="input-group">
            <input type="text" id="worker_out" placeholder="1. Buscar Trabajador (RUT o Nombre)..." onkeyup="buscarTrabajador(this.value)" autocomplete="off">
            <div id="worker_sugg" class="suggestions"></div>
        </div>
        
        <div class="input-group search-wrapper">
            <input type="text" id="tool_search" placeholder="2. Buscar √≠tem..." onkeyup="buscarHerramienta(this.value)" autocomplete="off" style="flex:1;">
            <input type="number" id="tool_qty" value="1" min="1" style="width: 80px; text-align: center;">
            <button class="btn-add" onclick="agregar()">+</button>
            <div id="tool_sugg" class="suggestions" style="top: 100%;"></div>
        </div>

        <div class="list-container" id="cart_list">
            </div>
        
        <button class="btn-main btn-blue" onclick="finalizarSalida()">CONFIRMAR SALIDA</button>
    </div>

    <div class="panel panel-right">
        <h2 style="color: var(--orange);">üì• Devoluci√≥n</h2>
        
        <input type="text" id="scan_ret" placeholder="Escanear RUT o Ticket QR..." onchange="buscarPendientes()" autofocus>
        
        <div class="list-container" id="return_area">
            <div style="text-align:center; padding:40px; color:#555;">
                Esperando lectura...<br>
                <small>Escanee el RUT o el c√≥digo QR del Ticket</small>
            </div>
        </div>

        <button id="btn_process_ret" class="btn-main btn-orange" style="display:none;" onclick="procesarDevolucionMasiva()">
            CONFIRMAR RECEPCI√ìN
        </button>
        
        <div style="text-align:center; margin-top:10px;">
            <a href="/logout" style="color:#666; text-decoration:none; font-size:0.9rem;">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <script>
        // ======================= L√ìGICA SALIDA =======================
        let carrito = [];
        let currentItem = null;

        // 1. BUSCADOR TRABAJADORES (NUEVO)
        function buscarTrabajador(q) {
            let box = document.getElementById('worker_sugg');
            if(q.length < 2){ box.style.display='none'; return; }
            
            fetch('/api/buscar_trabajador?q='+q)
            .then(r=>r.json())
            .then(data=>{
                box.innerHTML='';
                if(data.length > 0){
                    box.style.display='block';
                    data.forEach(w=>{
                        let d = document.createElement('div'); d.className='sugg-row';
                        d.innerHTML = `<div><b>${w.nombre}</b></div><div class="sugg-detail">${w.rut}</div>`;
                        d.onclick=()=>{ 
                            document.getElementById('worker_out').value = w.rut; // Guardamos el RUT
                            box.style.display='none'; 
                            document.getElementById('tool_search').focus();
                        }; 
                        box.appendChild(d);
                    });
                } else { box.style.display='none'; }
            });
        }

        // 2. BUSCADOR HERRAMIENTAS
        function buscarHerramienta(q) {
            let box = document.getElementById('tool_sugg');
            if(q.length < 1){ box.style.display='none'; return; }
            
            fetch('/api/buscar_herramientas?q='+q).then(r=>r.json()).then(data=>{
                box.innerHTML='';
                if(data.length > 0){
                    box.style.display='block';
                    data.forEach(i=>{
                        let d = document.createElement('div'); d.className='sugg-row';
                        let stockColor = i.stock > 0 ? '#10b981' : '#ef4444';
                        d.innerHTML = `
                            <div><b>${i.nombre}</b><br><span class="sugg-detail">${i.tipo}</span></div>
                            <div style="color:${stockColor}; font-weight:bold;">${i.stock}</div>`;
                        d.onclick=()=>{ 
                            currentItem=i; 
                            document.getElementById('tool_search').value=i.nombre; 
                            box.style.display='none'; 
                            if(i.tipo==='INSUMO') document.getElementById('tool_qty').select();
                            else document.getElementById('tool_qty').focus();
                        }; 
                        box.appendChild(d);
                    });
                } else { box.style.display='none'; }
            });
        }

        function agregar() {
            if(!currentItem) return alert("‚ö†Ô∏è Seleccione un √≠tem del listado.");
            let qty = parseInt(document.getElementById('tool_qty').value);
            
            if(qty > currentItem.stock) return alert("‚ùå Stock insuficiente. Quedan: " + currentItem.stock);
            
            carrito.push({...currentItem, cantidad: qty});
            renderCart();
            
            currentItem=null; 
            document.getElementById('tool_search').value=''; 
            document.getElementById('tool_qty').value='1';
            document.getElementById('tool_search').focus();
        }

        function renderCart() {
            let div = document.getElementById('cart_list'); div.innerHTML='';
            carrito.forEach((it,i)=>{
                div.innerHTML += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold">${it.nombre}</div>
                        <span class="badge ${it.tipo=='HERRAMIENTA'?'bg-tool':'bg-insu'}">${it.tipo}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <b style="font-size:1.2em">x${it.cantidad}</b>
                        <button style="background:none; color:var(--red); font-size:1.5em; border:none; cursor:pointer;" onclick="carrito.splice(${i},1);renderCart()">√ó</button>
                    </div>
                </div>`;
            });
        }

        function finalizarSalida() {
            let w = document.getElementById('worker_out').value.trim();
            if(!w) return alert("‚ö†Ô∏è Identifique al trabajador");
            if(carrito.length===0) return alert("‚ö†Ô∏è Carro vac√≠o");
            
            fetch('/procesar_salida_masiva', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({worker_id: w, items: carrito})
            }).then(r=>r.json()).then(d=>{
                if(d.status==='ok'){ 
                    window.open('/ticket/'+d.ticket_id, '_blank', 'width=400,height=600'); 
                    carrito=[]; renderCart(); 
                    document.getElementById('worker_out').value=''; 
                    document.getElementById('worker_out').focus();
                } else {
                    alert("Error: " + d.msg);
                }
            });
        }

        // ======================= L√ìGICA DEVOLUCI√ìN (CORREGIDA) =======================
        
        function buscarPendientes() {
            let input = document.getElementById('scan_ret').value.trim().toUpperCase();
            if(!input) return;

            let div = document.getElementById('return_area');
            div.innerHTML = '<div style="padding:20px; text-align:center; color:#f59e0b;">‚è≥ Buscando...</div>';
            document.getElementById('btn_process_ret').style.display = 'none';

            // Detectar si es Ticket (contiene TICKET: o es alfanum√©rico corto de 8 chars) o RUT (contiene gui√≥n o es largo)
            let url = '';
            
            // Limpieza b√°sica
            let limpio = input.replace('TICKET:', '').trim();

            // Si parece RUT (tiene digito verificador o gui√≥n)
            if (limpio.includes('-') || limpio.length > 8) {
                url = `/api/prestamos_trabajador?worker_id=${limpio.replace(/\./g, '')}`; // Quitar puntos para la API
            } else {
                // Asumimos que es Ticket ID
                url = `/api/prestamos_ticket?ticket_id=${limpio}`;
            }
            
            fetch(url).then(r => r.json()).then(data => {
                if (data.status === 'ok') {
                    renderPendientes(data.data);
                } else {
                    div.innerHTML = `<div style="padding:40px; text-align:center; color:#ef4444;"><h3>‚ùå ${data.msg}</h3></div>`;
                }
            }).catch(e => {
                div.innerHTML = `<div style="text-align:center; color:red;">Error de conexi√≥n</div>`;
            });

            document.getElementById('scan_ret').value = '';
            document.getElementById('scan_ret').focus(); // Mantener foco para escanear seguido
        }

        function renderPendientes(items) {
            let div = document.getElementById('return_area');
            let html = `<div style="padding:10px; text-align:center; background:#1f2937; margin-bottom:10px;">Pendientes: <b>${items.length}</b></div>`;
            
            items.forEach(p => {
                html += `
                <div class="list-item">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" class="check-big ret-check" data-id="${p.prestamo_id}" checked>
                        <div>
                            <div style="font-weight:bold;">${p.nombre}</div>
                            <div style="font-size:0.8em; color:#aaa;">C√≥d: ${p.tool_id}</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:1.2em; font-weight:bold;">${p.cantidad}</div>
                        <div style="font-size:0.7em;">UNID</div>
                    </div>
                </div>`;
            });
            div.innerHTML = html;
            document.getElementById('btn_process_ret').style.display = 'block';
        }

        function procesarDevolucionMasiva() {
            let checks = document.querySelectorAll('.ret-check:checked');
            if(checks.length === 0) return alert("Nada seleccionado");
            
            let items = [];
            checks.forEach(c => {
                // Asumimos devoluci√≥n total por defecto en interfaz r√°pida
                // Para cantidad parcial habr√≠a que habilitar un input, pero para operador r√°pido es mejor checkear todo
                let row = c.closest('.list-item');
                let qty = row.querySelector('div[style*="font-size:1.2em"]').innerText;
                items.push({ id: c.getAttribute('data-id'), cantidad: qty });
            });

            fetch('/procesar_devolucion_compleja', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ items: items })
            }).then(r=>r.json()).then(d=>{
                if(d.status==='ok'){
                    window.open('/ticket_devolucion?ids='+d.ids, '_blank', 'width=400,height=600');
                    document.getElementById('return_area').innerHTML = '<div style="text-align:center; padding:40px; color:#10b981;"><h3>‚úÖ Recibido Conforme</h3></div>';
                    document.getElementById('btn_process_ret').style.display = 'none';
                } else {
                    alert("Error: " + d.msg);
                }
            });
        }
    </script>
</body>
</html>
